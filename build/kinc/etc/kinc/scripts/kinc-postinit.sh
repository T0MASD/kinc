#!/bin/bash
set -euo pipefail

# Enhanced logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >&2
}

# Start overall timing
POSTINIT_START_TIME=$(date +%s)

log "=== kinc Post-Initialization Starting ==="

# Set kubeconfig for all kubectl commands
export KUBECONFIG=/etc/kubernetes/admin.conf

# Wait for node to register (happens automatically when kubelet starts)
log "Waiting for node to register with API server..."
timeout_counter=0
max_timeout=60
while ! kubectl get nodes 2>/dev/null | grep -q "Ready\|NotReady"; do
    log "Waiting for node registration... (${timeout_counter}s/${max_timeout}s)"
    sleep 2
    timeout_counter=$((timeout_counter + 2))
    if [[ $timeout_counter -ge $max_timeout ]]; then
        log "❌ Node failed to register within ${max_timeout} seconds"
        exit 1
    fi
done
log "✅ Node registered with API server"

# Now complete the kubelet config upload phase that we skipped earlier
log "Completing kubelet configuration upload..."
if kubeadm init phase upload-config kubelet --config=/tmp/kubeadm-final.conf; then
    log "✅ Kubelet configuration uploaded successfully"
else
    log "⚠️  Kubelet config upload failed, but node is registered - continuing..."
fi

# Kubelet configuration is now correctly generated by kubeadm from kubeadm.conf
log "✅ Kubelet configured for rootless operation via kubeadm config"

# Patch kube-proxy to remove privileged flag for rootless operation
log "Patching kube-proxy DaemonSet to remove privileged flag..."
if kubectl patch daemonset kube-proxy -n kube-system --type='json' -p='[{"op": "replace", "path": "/spec/template/spec/containers/0/securityContext/privileged", "value": false}]'; then
    log "✅ kube-proxy patched for rootless operation"
else
    log "❌ Failed to patch kube-proxy for rootless operation"
    exit 1
fi

# Wait for API server to be fully ready before installing any manifests
log "Waiting for API server to be ready..."
timeout_counter=0
max_timeout=60
while ! kubectl get --raw=/healthz >/dev/null 2>&1; do
    log "Waiting for API server to respond... (${timeout_counter}s/${max_timeout}s)"
    sleep 2
    timeout_counter=$((timeout_counter + 2))
    if [[ $timeout_counter -ge $max_timeout ]]; then
        log "❌ API server failed to become ready within ${max_timeout} seconds"
        exit 1
    fi
done

# Additional check: ensure API server can handle requests properly
log "Verifying API server functionality..."
if kubectl get nodes >/dev/null 2>&1; then
    log "✅ API server is ready and responsive"
else
    log "API server not fully ready, waiting additional 5 seconds..."
    sleep 5
    if kubectl get nodes >/dev/null 2>&1; then
        log "✅ API server is now ready and responsive"
    else
        log "❌ API server functionality verification failed"
        exit 1
    fi
fi

# Install CNI (using kinc's default CNI with proper templating)
log "Installing CNI..."
if [[ -f /kinc/manifests/default-cni.yaml ]]; then
    # Template the CNI manifest with the pod subnet from kubeadm config
    # Use hardcoded default that matches kubeadm.conf
    sed "s|{{ .PodSubnet }}|10.244.0.0/16|g" /kinc/manifests/default-cni.yaml > /tmp/cni-manifest.yaml
    
    if kubectl apply -f /tmp/cni-manifest.yaml; then
        log "✅ CNI installed successfully"
    else
        log "❌ Failed to install CNI"
        exit 1
    fi
else
    log "❌ CNI manifest not found at /kinc/manifests/default-cni.yaml"
    exit 1
fi

# Wait for CNI to be ready before proceeding
log "Waiting for CNI pods to be ready..."
wait_start=$(date +%s)
if kubectl wait --for=condition=Ready pods -l k8s-app=kincnet -n kube-system --timeout=180s; then
    wait_end=$(date +%s)
    wait_elapsed=$((wait_end - wait_start))
    log "✅ CNI pods are ready (waited ${wait_elapsed}s)"
else
    wait_end=$(date +%s)
    wait_elapsed=$((wait_end - wait_start))
    log "⚠️  CNI pods not ready yet after ${wait_elapsed}s, but continuing..."
fi

# Wait for nodes to be ready first
log "Waiting for node to be ready..."
wait_start=$(date +%s)
if kubectl wait --for=condition=Ready nodes --all --timeout=240s; then
    wait_end=$(date +%s)
    wait_elapsed=$((wait_end - wait_start))
    log "✅ All nodes are ready (waited ${wait_elapsed}s)"
else
    wait_end=$(date +%s)
    wait_elapsed=$((wait_end - wait_start))
    log "❌ Nodes failed to become ready after ${wait_elapsed}s"
    exit 1
fi

# Wait for control plane pods to be fully ready and stable
log "Waiting for control plane to be completely stable..."
components=("etcd" "kube-apiserver" "kube-controller-manager" "kube-scheduler")
for component in "${components[@]}"; do
    log "Waiting for $component to be ready..."
    wait_start=$(date +%s)
    if kubectl wait --for=condition=Ready pod -l component="$component" -n kube-system --timeout=180s; then
        wait_end=$(date +%s)
        wait_elapsed=$((wait_end - wait_start))
        log "✅ $component is ready (waited ${wait_elapsed}s)"
    else
        wait_end=$(date +%s)
        wait_elapsed=$((wait_end - wait_start))
        log "❌ $component failed to become ready after ${wait_elapsed}s"
        exit 1
    fi
done

# Additional stability check - ensure all control plane components are stable
log "Verifying control plane stability..."
sleep 5

# Remove control plane taint so storage provisioner can be scheduled
log "Removing control plane taint to allow workload scheduling..."
if kubectl taint nodes --all node-role.kubernetes.io/control-plane:NoSchedule- 2>/dev/null; then
    log "✅ Control plane taint removed"
else
    log "ℹ️  Control plane taint already removed or not present"
fi

# Now install storage class with fully stable control plane
log "Installing storage class..."
if [[ -f /kinc/manifests/default-storage.yaml ]]; then
    if kubectl apply -f /kinc/manifests/default-storage.yaml; then
        log "✅ Storage class installed successfully"
    else
        log "❌ Failed to install storage class"
        exit 1
    fi
else
    log "❌ Storage manifest not found at /kinc/manifests/default-storage.yaml"
    exit 1
fi

# Wait for storage provisioner to be ready
log "Waiting for storage provisioner to be ready..."
wait_start=$(date +%s)
if kubectl wait --for=condition=Available deployment/local-path-provisioner -n local-path-storage --timeout=180s; then
    wait_end=$(date +%s)
    wait_elapsed=$((wait_end - wait_start))
    log "✅ Storage provisioner is ready (waited ${wait_elapsed}s)"
else
    wait_end=$(date +%s)
    wait_elapsed=$((wait_end - wait_start))
    log "⚠️  Storage provisioner not ready after ${wait_elapsed}s, but continuing..."
fi

log "=== kinc Post-Initialization Complete ==="

# Calculate and log total post-initialization time
POSTINIT_END_TIME=$(date +%s)
POSTINIT_ELAPSED=$((POSTINIT_END_TIME - POSTINIT_START_TIME))

log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "⏱️  POST-INITIALIZATION TIMING"
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "   Post-initialization time: ${POSTINIT_ELAPSED}s"
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "Cluster is ready!"

log "=== Continuing with normal systemd operation ==="

exit 0

