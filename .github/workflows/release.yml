name: Build and Publish kinc Images

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1_33_5-0)'
        required: true
        default: 'v1_33_5-0'

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up build environment
        run: |
          echo "=== Setting up build environment ==="
          
          # Enable IP forwarding for container builds
          echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
          
          # Check Podman version
          podman --version
          
          # Determine tag
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          
          echo "Building tag: $TAG"
          echo "BUILD_TAG=$TAG" >> $GITHUB_ENV
          
          # Parse tag format: v1_33_5-0
          # Extract Kubernetes version (v1_33_5-0 -> 1.33.5)
          K8S_VERSION=$(echo "$TAG" | sed 's/^v//' | cut -d'-' -f1 | tr '_' '.')
          echo "K8S_VERSION=$K8S_VERSION" >> $GITHUB_ENV
          echo "Kubernetes version: $K8S_VERSION"
          
          # Extract kinc patch version (v1_33_5-0 -> 0)
          KINC_PATCH=$(echo "$TAG" | cut -d'-' -f2)
          echo "KINC_PATCH=$KINC_PATCH" >> $GITHUB_ENV
          echo "kinc patch version: $KINC_PATCH"
          
          # Convert repository name to lowercase for container registry
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=$REPO_LOWER" >> $GITHUB_ENV
          echo "Image name: $REPO_LOWER"

      - name: Log in to Container Registry
        run: |
          echo "=== Logging in to ${{ env.REGISTRY }} ==="
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build kinc node image
        run: |
          echo "=== Building kinc node image ==="
          
          cd build
          
          # Build the kinc node image with proper tags
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.BUILD_TAG }}"
          LATEST_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          LOCAL_TEST_TAG="localhost/kinc/node:v1.33.5-test"
          
          echo "Building image: $IMAGE_TAG"
          echo "Also tagging for local testing: $LOCAL_TEST_TAG"
          
          # Build with cache busting and proper labels
          podman build \
            -f Containerfile \
            -t "$IMAGE_TAG" \
            -t "$LATEST_TAG" \
            -t "$LOCAL_TEST_TAG" \
            --build-arg CACHE_BUST="${{ github.run_number }}" \
            --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.version=${{ env.BUILD_TAG }}" \
            --label "org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --label "io.kinc.version=${{ env.K8S_VERSION }}" \
            --label "io.kinc.kubernetes.version=${{ env.K8S_VERSION }}" \
            .
          
          echo "‚úÖ Build completed successfully"
          
          # Show image info
          podman images | grep kinc

      - name: Test built image
        run: |
          echo "=== Testing built image using kinc tools ==="
          
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.BUILD_TAG }}"
          
          # Basic image inspection
          echo "Image details:"
          podman inspect "$IMAGE_TAG" --format '{{json .Config.Labels}}' | jq .
          
          # Test the locally built image using kinc tools
          echo "Testing locally built image with deployment..."
          
          export CLUSTER_NAME="test"
          
          # Deploy cluster
          echo "Deploying test cluster..."
          ./tools/deploy.sh
          
          # Wait for initialization
          echo "Waiting for cluster initialization..."
          max_wait=300
          waited=0
          while [ $waited -lt $max_wait ]; do
            if podman exec kinc-test-control-plane test -f /var/lib/kinc-initialized 2>/dev/null; then
              echo "‚úÖ Cluster initialized (${waited}s)"
              break
            fi
            if [ $waited -ge $max_wait ]; then
              echo "‚ùå Cluster initialization timeout"
              exit 1
            fi
            sleep 5
            waited=$((waited + 5))
          done
          
          # Verify cluster is functional
          export KUBECONFIG=~/.kube/kinc-test-config
          kubectl get nodes
          kubectl get pods -A
          
          echo "‚úÖ kinc image validation passed - deployment successful!"
          
          # Cleanup
          CLUSTER_NAME=test ./tools/cleanup.sh || true

      - name: Push images to registry
        run: |
          echo "=== Pushing images to registry ==="
          
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.BUILD_TAG }}"
          LATEST_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          
          # Push versioned tag
          echo "Pushing $IMAGE_TAG..."
          podman push "$IMAGE_TAG"
          
          # Push latest tag (only for non-pre-release versions)
          if [[ "${{ env.BUILD_TAG }}" != *"-"* ]]; then
            echo "Pushing $LATEST_TAG..."
            podman push "$LATEST_TAG"
          else
            echo "Skipping latest tag for pre-release version"
          fi
          
          echo "‚úÖ Images pushed successfully"

      - name: Generate image usage examples
        run: |
          echo "=== Image Usage Examples ==="
          
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.BUILD_TAG }}"
          
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## üéâ kinc Image Published Successfully!
          
          **Image**: \`$IMAGE_TAG\`
          **Kubernetes Version**: \`${{ env.K8S_VERSION }}\`
          **Build**: \`${{ github.run_number }}\`
          
          ### üìã Usage Examples
          
          > **Note**: kinc requires **rootless Podman** (runs as regular user, not root).
          
          #### Option 1: Quick Start with Deployment Tools (Recommended)
          \`\`\`bash
          # Clone kinc repository
          git clone https://github.com/t0masd/kinc.git && cd kinc
          
          # Enable IP forwarding (one-time setup)
          echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
          
          # Deploy using published image with baked-in config (zero-config)
          export KINC_IMAGE=$IMAGE_TAG
          export USE_BAKED_IN_CONFIG=true
          ./tools/deploy.sh
          # Note: deploy.sh waits for cluster to be fully ready
          #   First run: 2-5 minutes (downloads container images)
          #   Subsequent runs: ~40 seconds (cached images)
          
          # Extract kubeconfig
          mkdir -p ~/.kube
          podman cp kinc-default-control-plane:/etc/kubernetes/admin.conf ~/.kube/config
          sed -i 's|server: https://.*:6443|server: https://127.0.0.1:6443|g' ~/.kube/config
          
          # Use cluster (fully ready)
          kubectl get nodes
          kubectl get pods -A
          
          # Cleanup
          ./tools/cleanup.sh
          \`\`\`
          
          > **Note**: First deployment takes 2-5 minutes (downloads pause, CoreDNS, kube-proxy, etc.). Subsequent deployments are ~40 seconds.
          
          #### Option 2: Direct Podman Run (Advanced)
          \`\`\`bash
          # Create volume for persistent data
          podman volume create kinc-var-data
          
          # Start kinc cluster (rootless - must run as regular user, NOT root!)
          podman run -d --name kinc-cluster \\
            --hostname kinc-control-plane \\
            --cgroups=split \\
            --cap-add=SYS_ADMIN --cap-add=SYS_RESOURCE --cap-add=NET_ADMIN \\
            --cap-add=SETPCAP --cap-add=NET_RAW --cap-add=SYS_PTRACE \\
            --cap-add=DAC_OVERRIDE --cap-add=CHOWN --cap-add=FOWNER \\
            --cap-add=FSETID --cap-add=KILL --cap-add=SETGID --cap-add=SETUID \\
            --cap-add=NET_BIND_SERVICE --cap-add=SYS_CHROOT --cap-add=SETFCAP \\
            --cap-add=DAC_READ_SEARCH --cap-add=AUDIT_WRITE \\
            --device /dev/fuse \\
            --tmpfs /tmp:rw,rprivate,nosuid,nodev,tmpcopyup \\
            --tmpfs /run:rw,rprivate,nosuid,nodev,tmpcopyup \\
            --tmpfs /run/lock:rw,rprivate,nosuid,nodev,tmpcopyup \\
            --volume kinc-var-data:/var:rw \\
            --volume \$HOME/.local/share/containers/storage:/root/.local/share/containers/storage:rw \\
            --sysctl net.ipv6.conf.all.disable_ipv6=0 \\
            --sysctl net.ipv6.conf.all.keep_addr_on_down=1 \\
            --sysctl net.netfilter.nf_conntrack_tcp_timeout_established=86400 \\
            --sysctl net.netfilter.nf_conntrack_tcp_timeout_close_wait=3600 \\
            -p 127.0.0.1:6443:6443/tcp \\
            --env container=podman \\
            $IMAGE_TAG
          
          # Wait for API server to be ready (returns HTTP 200)
          timeout 300 bash -c 'until curl -k -s -o /dev/null -w "%{http_code}" https://localhost:6443/healthz 2>/dev/null | grep -q "200"; do sleep 2; done'
          echo "‚úÖ API server responding"
          
          # Extract kubeconfig
          mkdir -p ~/.kube
          podman cp kinc-cluster:/etc/kubernetes/admin.conf ~/.kube/config
          sed -i 's|server: https://.*:6443|server: https://127.0.0.1:6443|g' ~/.kube/config
          
          # Check cluster status
          kubectl get nodes
          kubectl get pods -A
          
          # Optional: Wait for all system pods to be fully ready (~40 seconds)
          echo "‚è≥ Waiting for system pods..."
          kubectl wait --for=condition=Ready pods --all -n kube-system --timeout=300s
          
          # Wait for storage provisioner (namespace and pods created after control plane)
          timeout 60 bash -c 'until kubectl get namespace local-path-storage >/dev/null 2>&1; do sleep 2; done'
          timeout 60 bash -c 'until kubectl get pods -n local-path-storage 2>/dev/null | grep -q local-path-provisioner; do sleep 2; done'
          kubectl wait --for=condition=Ready pods --all -n local-path-storage --timeout=60s
          echo "‚úÖ Cluster ready"
          
          # Cleanup
          podman rm -f kinc-cluster
          podman volume rm kinc-var-data
          \`\`\`
          
          > **Note**: The healthcheck waits for the API server to return HTTP 200 (~20 seconds on first run). The optional \`kubectl wait\` commands ensure all system pods are Ready before deploying workloads.
          
          > **‚ö†Ô∏è Performance Warning**: 
          > - **First run**: Initialization takes 2-5 minutes (downloads pause, CoreDNS, kube-proxy, etc.)
          > - **Subsequent runs** (with container storage mount): ~40 seconds (images cached)
          > - **Without container storage mount**: Every run downloads images (2-5 minutes each time)
          > - **Recommendation**: Always use \`--volume \$HOME/.local/share/containers/storage\` for image caching
          
          **Key requirements**:
          - \`--cgroups=split\`: Proper cgroup hierarchy for Kubernetes
          - \`--volume kinc-var-data:/var\`: Persistent storage for etcd and kubelet
          - \`--volume \$HOME/.local/share/containers/storage\`: **Critical** - Shares image cache with host, enables ~40s init time
          - Additional sysctls: Conntrack timeouts for stable networking
          
          #### GitHub Actions / CI Usage
          \`\`\`yaml
          - name: Setup kinc Kubernetes cluster
            run: |
              # Enable IP forwarding
              echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
              
              # Deploy kinc using deployment tools (handles rootless setup)
              export KINC_IMAGE=$IMAGE_TAG
              export USE_BAKED_IN_CONFIG=true
              git clone https://github.com/t0masd/kinc.git /tmp/kinc
              cd /tmp/kinc && ./tools/deploy.sh
              
              # Extract kubeconfig
              mkdir -p ~/.kube
              podman cp kinc-default-control-plane:/etc/kubernetes/admin.conf ~/.kube/config
              sed -i 's|server: https://.*:6443|server: https://127.0.0.1:6443|g' ~/.kube/config
              
              # Verify cluster
              kubectl get nodes
          
          - name: Cleanup
            if: always()
            run: cd /tmp/kinc && ./tools/cleanup.sh
          \`\`\`
          
          #### Multi-Cluster Usage
          \`\`\`bash
          # Use kinc tools for multi-cluster (handles rootless config automatically)
          export KINC_IMAGE=$IMAGE_TAG
          
          # Deploy multiple clusters
          CLUSTER_NAME=dev ./tools/deploy.sh
          CLUSTER_NAME=staging ./tools/deploy.sh
          
          # Extract separate kubeconfigs
          podman cp kinc-dev:/etc/kubernetes/admin.conf ~/.kube/config-dev
          podman cp kinc-staging:/etc/kubernetes/admin.conf ~/.kube/config-staging
          
          # Update server URLs
          sed -i 's|server: https://.*:6443|server: https://127.0.0.1:6444|g' ~/.kube/config-dev
          sed -i 's|server: https://.*:6443|server: https://127.0.0.1:6445|g' ~/.kube/config-staging
          \`\`\`
          
          #### Zero-Config Deployment (Baked-in Configuration)
          \`\`\`bash
          # Fastest deployment - uses embedded configuration
          export KINC_IMAGE=$IMAGE_TAG
          export USE_BAKED_IN_CONFIG=true
          
          # Deploy with baked-in configuration (no config volume needed)
          ./tools/deploy.sh
          
          # Or multiple clusters
          USE_BAKED_IN_CONFIG=true CLUSTER_NAME=dev ./tools/deploy.sh
          USE_BAKED_IN_CONFIG=true CLUSTER_NAME=test ./tools/deploy.sh
          
          # Benefits:
          # - No external config volume required
          # - Faster deployment
          # - Minimal resource footprint
          # - Ideal for testing and CI/CD
          \`\`\`
          
          ### üîó Links
          - **Registry**: [ghcr.io/${{ env.IMAGE_NAME }}](https://github.com/${{ github.repository }}/pkgs/container/kinc)
          - **Source**: [github.com/${{ github.repository }}](https://github.com/${{ github.repository }})
          - **Documentation**: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          EOF

      - name: Create release notes
        if: github.event_name == 'push'
        run: |
          echo "=== Creating release notes ==="
          
          cat << EOF > release-notes.md
          # kinc ${{ env.BUILD_TAG }}
          
          Kubernetes **${{ env.K8S_VERSION }}** ‚Ä¢ kinc patch **${{ env.KINC_PATCH }}**
          
          ## üì¶ Container Image
          
          \`\`\`bash
          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.BUILD_TAG }}
          \`\`\`
          
          ## üöÄ Quick Start
          
          \`\`\`bash
          # Recommended: Use kinc tools (handles rootless configuration)
          export KINC_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.BUILD_TAG }}
          git clone https://github.com/t0masd/kinc.git && cd kinc
          ./tools/deploy.sh
          
          # Wait for ready
          timeout 300 bash -c 'until curl -k https://localhost:6443/healthz; do sleep 5; done'
          
          # Get kubeconfig
          podman cp kinc:/etc/kubernetes/admin.conf ~/.kube/config
          sed -i 's|server: https://.*:6443|server: https://127.0.0.1:6443|g' ~/.kube/config
          
          # Use cluster
          kubectl get nodes
          \`\`\`
          
          ## üìã What's Included
          
          - Kubernetes ${{ env.K8S_VERSION }}
          - CRI-O container runtime
          - CNI networking (kincnet)
          - local-path-provisioner for storage
          - CoreDNS for service discovery
          - Rootless operation support
          - Baked-in configuration (zero-config deployment option)
          - Direct podman run support
          
          ## üîß Build Info
          
          - **Build Number**: ${{ github.run_number }}
          - **Commit**: ${{ github.sha }}
          - **Built**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          EOF
          
          echo "Release notes created"

  # Optional: Create GitHub release if this was triggered by a tag
  create-release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create GitHub Release
        run: |
          # Set image name (repository in lowercase)
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # Parse tag to extract versions
          K8S_VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//' | cut -d'-' -f1 | tr '_' '.')
          KINC_PATCH=$(echo "${{ github.ref_name }}" | cut -d'-' -f2)
          
          # Create release notes
          cat << EOF > release-notes.md
          # kinc ${{ github.ref_name }}
          
          Kubernetes **${K8S_VERSION}** ‚Ä¢ kinc patch **${KINC_PATCH}**
          
          üéâ **Container image available**: \`ghcr.io/${IMAGE_NAME}:${{ github.ref_name }}\`
          
          ## Quick Start
          
          ### Standard Deployment (Mounted Configuration)
          \`\`\`bash
          # Recommended: Use kinc tools for proper rootless setup
          export KINC_IMAGE=ghcr.io/${IMAGE_NAME}:${{ github.ref_name }}
          git clone https://github.com/t0masd/kinc.git && cd kinc
          ./tools/deploy.sh
          \`\`\`
          
          ### Zero-Config Deployment (Baked-in Configuration)
          \`\`\`bash
          # Fastest deployment - uses embedded configuration
          export KINC_IMAGE=ghcr.io/${IMAGE_NAME}:${{ github.ref_name }}
          export USE_BAKED_IN_CONFIG=true
          git clone https://github.com/t0masd/kinc.git && cd kinc
          ./tools/deploy.sh
          \`\`\`
          
          See the [usage examples](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
          EOF
          
          # Create release using gh CLI
          # Extract patch version to determine if pre-release
          PATCH_VERSION=$(echo "${{ github.ref_name }}" | cut -d'-' -f2)
          
          # If patch contains non-numeric characters (rc, beta, alpha, etc.), it's a pre-release
          if [[ "$PATCH_VERSION" =~ [^0-9] ]]; then
            # Pre-release (e.g., v1_33_5-rc0, v1_33_5-beta1)
            echo "Creating pre-release for ${{ github.ref_name }}"
            gh release create "${{ github.ref_name }}" \
              --title "kinc ${{ github.ref_name }}" \
              --notes-file release-notes.md \
              --prerelease
          else
            # Regular release (e.g., v1_33_5-0, v1_33_5-1)
            echo "Creating stable release for ${{ github.ref_name }}"
            gh release create "${{ github.ref_name }}" \
              --title "kinc ${{ github.ref_name }}" \
              --notes-file release-notes.md
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
