name: kinc CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-baked-in:
    runs-on: ubuntu-latest
    name: Test (baked-in config)
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable IP forwarding
        run: echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward

      - name: Build image
        run: |
          echo "=== Building kinc image ==="
          ./tools/build.sh
          echo "✅ Image built: localhost/kinc/node:v1.33.5"
        shell: bash

      - name: Deploy single cluster with baked-in config
        run: |
          echo "=== Deploying default cluster with baked-in configuration ==="
          
          export USE_BAKED_IN_CONFIG=true
          
          bash ./tools/deploy-and-test.sh > /tmp/deploy-default.log 2>&1 &
          deploy_pid=$!
          
          # Wait for port to be bound
          echo "⏳ Waiting for cluster port..."
          max_wait=600
          waited=0
          cluster_port=""
          
          while [ $waited -lt $max_wait ]; do
            if ! kill -0 $deploy_pid 2>/dev/null; then
              if wait $deploy_pid; then
                echo "✅ Deployment completed"
              else
                echo "❌ Deployment failed"
                cat /tmp/deploy-default.log || true
                exit 1
              fi
            fi
            
            if podman ps --format "{{.Names}}" | grep -q "^kinc-default-control-plane$"; then
              cluster_port=$(podman inspect kinc-default-control-plane --format '{{range $p, $conf := .NetworkSettings.Ports}}{{range $conf}}{{.HostPort}}{{end}}{{end}}' 2>/dev/null)
              if [[ -n "$cluster_port" && "$cluster_port" =~ ^[0-9]+$ ]]; then
                echo "✅ Cluster bound to port $cluster_port"
                break
              fi
            fi
            
            sleep 5
            waited=$((waited + 5))
          done
          
          if [[ -z "$cluster_port" ]]; then
            echo "❌ Cluster failed to bind port within timeout"
            cat /tmp/deploy-default.log || true
            exit 1
          fi
          
          echo "CLUSTER_PORT=$cluster_port" >> $GITHUB_ENV
          
          # Wait for deploy-and-test.sh to complete (it does full init + validation)
          echo "⏳ Waiting for deploy-and-test.sh to complete..."
          if wait $deploy_pid; then
            echo "✅ Deployment and tests completed successfully"
          else
            echo "❌ Deployment or tests failed"
            cat /tmp/deploy-default.log || true
            exit 1
          fi
        shell: bash

      - name: Wait for API server
        run: |
          echo "=== Waiting for API server ==="
          
          port=${{ env.CLUSTER_PORT }}
          
          echo "⏳ Waiting for API server (port $port)..."
          
          max_attempts=300
          for i in $(seq 1 $max_attempts); do
            if curl -k -s https://127.0.0.1:$port/healthz >/dev/null 2>&1; then
              echo "✅ API server ready"
              break
            fi
            
            if [ $((i % 12)) -eq 0 ]; then
              echo "Still waiting... (attempt $i/$max_attempts)"
            fi
            sleep 5
          done
          
          if ! curl -k -s https://127.0.0.1:$port/healthz >/dev/null 2>&1; then
            echo "❌ API server failed to become ready"
            exit 1
          fi
        shell: bash

      - name: Extract kubeconfig
        run: |
          echo "=== Extracting kubeconfig ==="
          mkdir -p ~/.kube
          
          port=${{ env.CLUSTER_PORT }}
          
          podman cp kinc-default-control-plane:/etc/kubernetes/admin.conf ~/.kube/config
          sed -i "s|server: https://.*:6443|server: https://127.0.0.1:$port|g" ~/.kube/config
          
          echo "✅ Kubeconfig ready"
        shell: bash

      - name: Verify baked-in config
        run: |
          echo "=== Verifying baked-in configuration ==="
          
          # Check kinc-init.service logs inside container (logs go to journald, not podman logs)
          config_source=$(podman exec kinc-default-control-plane journalctl -u kinc-init.service --no-pager 2>/dev/null | grep -oP '(Using mounted configuration|No mounted config found, using baked-in configuration)' | head -1)
          
          echo "Configuration source: $config_source"
          
          if [[ "$config_source" == *"baked-in"* ]]; then
            echo "✅ Using baked-in config as expected"
          else
            echo "❌ NOT using baked-in config"
            echo "kinc-init.service logs:"
            podman exec kinc-default-control-plane journalctl -u kinc-init.service --no-pager 2>/dev/null || true
            exit 1
          fi
        shell: bash

      - name: Validate cluster
        run: |
          echo "=== Validating cluster ==="
          
          echo "Nodes:"
          kubectl get nodes
          
          echo ""
          echo "Pods:"
          kubectl get pods -A
          
          echo ""
          echo "Services:"
          kubectl get svc -A
          
          echo "✅ Cluster validated"
        shell: bash

      - name: Collect diagnostics
        if: always()
        run: |
          echo "=== Collecting diagnostics ==="
          mkdir -p artifacts
          
          cp /tmp/deploy-default.log artifacts/ 2>&1 || true
          
          systemctl --user status kinc-default-control-plane.service > artifacts/systemd-status.txt 2>&1 || true
          journalctl --user -xeu kinc-default-control-plane.service --no-pager > artifacts/systemd-logs.txt 2>&1 || true
          podman logs kinc-default-control-plane > artifacts/container.log 2>&1 || true
          
          # Get kinc-init logs from inside container (they go to journald, not podman logs)
          podman exec kinc-default-control-plane journalctl -u kinc-init.service --no-pager > artifacts/kinc-init.log 2>&1 || true
          
          kubectl cluster-info dump > artifacts/cluster-info.txt 2>&1 || true
          kubectl get all -A > artifacts/resources.txt 2>&1 || true
          kubectl get events -A --sort-by='.lastTimestamp' > artifacts/events.txt 2>&1 || true
          
          netstat -tlnp > artifacts/network-ports.txt 2>&1 || true
          ip addr show > artifacts/network-interfaces.txt 2>&1 || true
        shell: bash

      - name: Upload diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kinc-diagnostics-baked-in-${{ github.run_number }}
          path: artifacts/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up..."
          bash ./tools/cleanup.sh || true
        shell: bash

  test-mounted:
    runs-on: ubuntu-latest
    name: Test (mounted config)
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable IP forwarding
        run: echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward

      - name: Build image
        run: |
          echo "=== Building kinc image ==="
          ./tools/build.sh
          echo "✅ Image built: localhost/kinc/node:v1.33.5"
        shell: bash

      - name: Deploy single cluster with mounted config
        run: |
          echo "=== Deploying default cluster with mounted configuration ==="
          
          # Do NOT set USE_BAKED_IN_CONFIG - use default mounted config behavior
          
          bash ./tools/deploy-and-test.sh > /tmp/deploy-default.log 2>&1 &
          deploy_pid=$!
          
          # Wait for port to be bound
          echo "⏳ Waiting for cluster port..."
          max_wait=600
          waited=0
          cluster_port=""
          
          while [ $waited -lt $max_wait ]; do
            if ! kill -0 $deploy_pid 2>/dev/null; then
              if wait $deploy_pid; then
                echo "✅ Deployment completed"
              else
                echo "❌ Deployment failed"
                cat /tmp/deploy-default.log || true
                exit 1
              fi
            fi
            
            if podman ps --format "{{.Names}}" | grep -q "^kinc-default-control-plane$"; then
              cluster_port=$(podman inspect kinc-default-control-plane --format '{{range $p, $conf := .NetworkSettings.Ports}}{{range $conf}}{{.HostPort}}{{end}}{{end}}' 2>/dev/null)
              if [[ -n "$cluster_port" && "$cluster_port" =~ ^[0-9]+$ ]]; then
                echo "✅ Cluster bound to port $cluster_port"
                break
              fi
            fi
            
            sleep 5
            waited=$((waited + 5))
          done
          
          if [[ -z "$cluster_port" ]]; then
            echo "❌ Cluster failed to bind port within timeout"
            cat /tmp/deploy-default.log || true
            exit 1
          fi
          
          echo "CLUSTER_PORT=$cluster_port" >> $GITHUB_ENV
          
          # Wait for deploy-and-test.sh to complete (it does full init + validation)
          echo "⏳ Waiting for deploy-and-test.sh to complete..."
          if wait $deploy_pid; then
            echo "✅ Deployment and tests completed successfully"
          else
            echo "❌ Deployment or tests failed"
            cat /tmp/deploy-default.log || true
            exit 1
          fi
        shell: bash

      - name: Extract kubeconfig
        run: |
          echo "=== Extracting kubeconfig ==="
          mkdir -p ~/.kube
          
          port=${{ env.CLUSTER_PORT }}
          
          podman cp kinc-default-control-plane:/etc/kubernetes/admin.conf ~/.kube/config
          sed -i "s|server: https://.*:6443|server: https://127.0.0.1:$port|g" ~/.kube/config
          
          echo "✅ Kubeconfig ready"
        shell: bash

      - name: Verify mounted config
        run: |
          echo "=== Verifying mounted configuration ==="
          
          # Check kinc-init.service logs inside container
          config_source=$(podman exec kinc-default-control-plane journalctl -u kinc-init.service --no-pager 2>/dev/null | grep -oP '(Using mounted configuration|No mounted config found, using baked-in configuration)' | head -1)
          
          echo "Configuration source: $config_source"
          
          if [[ "$config_source" == *"mounted"* ]]; then
            echo "✅ Using mounted config as expected"
          else
            echo "❌ NOT using mounted config"
            echo "kinc-init.service logs:"
            podman exec kinc-default-control-plane journalctl -u kinc-init.service --no-pager 2>/dev/null || true
            exit 1
          fi
        shell: bash

      - name: Validate cluster
        run: |
          echo "=== Validating cluster ==="
          
          echo "Nodes:"
          kubectl get nodes
          
          echo ""
          echo "Pods:"
          kubectl get pods -A
          
          echo ""
          echo "Services:"
          kubectl get svc -A
          
          echo "✅ Cluster validated"
        shell: bash

      - name: Collect diagnostics
        if: always()
        run: |
          echo "=== Collecting diagnostics ==="
          mkdir -p artifacts
          
          cp /tmp/deploy-default.log artifacts/ 2>&1 || true
          
          systemctl --user status kinc-default-control-plane.service > artifacts/systemd-status.txt 2>&1 || true
          journalctl --user -xeu kinc-default-control-plane.service --no-pager > artifacts/systemd-logs.txt 2>&1 || true
          podman logs kinc-default-control-plane > artifacts/container.log 2>&1 || true
          
          # Get kinc-init logs from inside container
          podman exec kinc-default-control-plane journalctl -u kinc-init.service --no-pager > artifacts/kinc-init.log 2>&1 || true
          
          kubectl cluster-info dump > artifacts/cluster-info.txt 2>&1 || true
          kubectl get all -A > artifacts/resources.txt 2>&1 || true
          kubectl get events -A --sort-by='.lastTimestamp' > artifacts/events.txt 2>&1 || true
          
          netstat -tlnp > artifacts/network-ports.txt 2>&1 || true
          ip addr show > artifacts/network-interfaces.txt 2>&1 || true
        shell: bash

      - name: Upload diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kinc-diagnostics-mounted-${{ github.run_number }}
          path: artifacts/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up..."
          bash ./tools/cleanup.sh || true
        shell: bash
