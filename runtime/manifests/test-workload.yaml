---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: test-data-collector
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kinc-test-reader
rules:
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kinc-test-reader-binding
subjects:
- kind: ServiceAccount
  name: test-data-collector
  namespace: default
roleRef:
  kind: ClusterRole
  name: kinc-test-reader
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Mi
---
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
  labels:
    app: test-workload
spec:
  serviceAccountName: test-data-collector
  initContainers:
  - name: generate-data
    # Use official Google Cloud SDK with kubectl
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
    command: ["/bin/bash", "-c"]
    args:
    - |
      echo "Gathering node information via kubectl..."
      kubectl get node "$NODE_NAME_ENV" -o json > /data/node-info.json
      echo "âœ… Node info collected and saved to /data/node-info.json"
    env:
    # Use Downward API to inject node name
    - name: NODE_NAME_ENV
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    volumeMounts:
    - name: test-storage
      mountPath: /data
  containers:
  - name: http-server
    image: python:3.11-alpine
    command: ["/bin/sh", "-c"]
    args:
    - |
      cd /data
      echo "ðŸš€ Starting HTTP server on port 8080..."
      python3 -m http.server 8080
    ports:
    - containerPort: 8080
      name: http
    volumeMounts:
    - name: test-storage
      mountPath: /data
    readinessProbe:
      httpGet:
        path: /node-info.json
        port: 8080
      initialDelaySeconds: 2
      periodSeconds: 2
    livenessProbe:
      httpGet:
        path: /node-info.json
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 10
  volumes:
  - name: test-storage
    persistentVolumeClaim:
      claimName: test-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: test-service
spec:
  selector:
    app: test-workload
  ports:
  - port: 80
    targetPort: 8080
    name: http
  type: ClusterIP
---
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: kinc-gateway-class
spec:
  controllerName: kinc.io/gateway-controller
  description: "kinc test gateway class"
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: test-gateway
spec:
  gatewayClassName: kinc-gateway-class
  listeners:
  - name: http
    protocol: HTTP
    port: 8080
    allowedRoutes:
      namespaces:
        from: Same
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: test-route
spec:
  parentRefs:
  - name: test-gateway
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: test-service
      port: 80
